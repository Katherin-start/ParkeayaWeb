<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head th:replace="~{fragments/header :: head}">
    <link th:href="@{/css/home.css}" rel="stylesheet">
</head>

<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <!-- Hero Section con Carrusel de Imágenes -->
    <section class="hero-section">
        <div class="hero-carousel">
            <!-- Imagen 1 -->
            <div class="carousel-slide active">
                <img th:src="@{/images/estaciomiento1.jpg}" alt="Estacionamiento Moderno" class="hero-bg-image">
                <div class="hero-overlay"></div>
            </div>
            <!-- Imagen 2 -->
            <div class="carousel-slide">
                <img th:src="@{/images/estacionamiento2.jpg}" alt="App Parkea Ya" class="hero-bg-image">
                <div class="hero-overlay"></div>
            </div>
            <!-- Imagen 3 -->
            <div class="carousel-slide">
                <img th:src="@{/images/estaciomientos3.jpg}" alt="Ciudad Inteligente" class="hero-bg-image">
                <div class="hero-overlay"></div>
            </div>
            <!-- Imagen 4 -->
            <div class="carousel-slide">
                <img th:src="@{/images/estaciomiento4.jpeg}" alt="Tecnología Avanzada" class="hero-bg-image">
                <div class="hero-overlay"></div>
            </div>
        </div>

        <!-- Controles del carrusel -->
        <div id="hero-carousel-controls" class="carousel-controls" role="region"
            aria-label="Controles del carrusel principal">
            <button class="carousel-prev">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="carousel-next">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <div class="hero-center-content">
    <div class="hero-content text-center">

        <div class="innovation-badge mb-4">
            <span class="badge-content">
                <i class="fas fa-bolt me-2"></i>
                Plataforma Inteligente
            </span>
        </div>

        <h1 class="hero-title mb-4">
            <span class="title-main">Parkea Ya</span>
            <span class="title-subtitle">Estacionamiento Inteligente</span>
        </h1>

        <p class="hero-description mb-5">
            La plataforma digital que revoluciona la movilidad urbana conectando conductores con
            estacionamientos verificados en tiempo real.
            <strong>Optimizamos espacios, reducimos emisiones y mejoramos la experiencia de
                movilidad</strong> para ciudades más inteligentes.
        </p>

        <div class="hero-actions mb-5">
            <div class="action-buttons justify-content-center">
                <a th:href="@{/solicitar-acceso}" class="btn btn-primary btn-hero me-3">
                    <i class="fas fa-building me-2"></i>
                    <span>Registrar Estacionamiento</span>
                </a>
                <a th:href="@{/descargar-app}" class="btn btn-outline-light btn-hero">
                    <i class="fas fa-mobile-alt me-2"></i>
                    <span>Descargar App</span>
                </a>
            </div>
        </div>

    </div>
</div>

    </section>
    <!-- mapa estacionamientos -->
<section class="map-section">
    <div class="container">
        <div class="map-container">
            <div class="row g-0">
                <div class="col-lg-6">
                    <div class="map-content">
                        <h2 class="map-title">
                            No esperes más
                            <span>Únete a nuestro equipo Parkea Ya</span>
                        </h2>

                        
                        <div class="map-benefits">
                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="benefit-text">
                                    <h4>Aumenta tus ingresos</h4>
                                </div>
                            </div>
                            
                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="benefit-text">
                                    <h4>Automatización total</h4>
                                </div>
                            </div>
                            
                            <div class="benefit-item">
                                <div class="benefit-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="benefit-text">
                                    <h4>Más clientes</h4>
                                </div>
                            </div>
                        </div>
                        
                        <div class="map-cta">
                            <h3>Estacionamientos cercanos</h3>
                            

                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div id="map" style="width:100%; height:600px; border-radius:16px; overflow:hidden; box-shadow:10 15px 40px rgba(0,0,0,0.18); margin-bottom:30px;"></div>

                </div>
            </div>
        </div>
    </div>
</section>

    <!-- Sección de Beneficios con Imágenes Grandes -->
    <section class="benefits-large-section">
        <div class="container">
            <div class="row text-center mb-5">
                <div class="col-12">
                    <h2 class="section-title-large">Beneficios que Transforman tu Experiencia</h2>
                    <p class="section-subtitle-large">Descubre cómo Parkea Ya revoluciona la forma de estacionar</p>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-md-6 col-lg-4">
                    <div class="benefit-large-card">
                        <div class="benefit-large-image">
                            <img th:src="@{/images/ahoorro.jpg}" alt="Ahorro de Tiempo" class="img-fluid">
                        </div>
                        <div class="benefit-large-content">
                            <h3 class="benefit-title">Ahorra Tiempo</h3>
                            <p class="benefit-text">Encuentra estacionamiento en segundos con nuestra tecnología
                                inteligente</p>
                            <div class="benefit-highlight">
                                <span class="highlight-text">+50% más eficiente</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="benefit-large-card">
                        <div class="benefit-large-image">
                            <img th:src="@{/images/rapides.png}" alt="Ahorro de Dinero" class="img-fluid">
                        </div>
                        <div class="benefit-large-content">
                            <h3 class="benefit-title">Ahorra Dinero</h3>
                            <p class="benefit-text">Compara precios y encuentra las mejores tarifas en tu zona</p>
                            <div class="benefit-highlight">
                                <span class="highlight-text">Hasta 40% de ahorro</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 col-lg-4">
                    <div class="benefit-large-card">
                        <div class="benefit-large-image">
                            <img th:src="@{/images/estacionamiento seguros .png}" alt="Estacionamientos Verificados"
                                class="img-fluid">
                        </div>
                        <div class="benefit-large-content">
                            <h3 class="benefit-title">Estacionamientos Verificados</h3>
                            <p class="benefit-text">Espacios seguros y confiables con verificación completa</p>
                            <div class="benefit-highlight">
                                <span class="highlight-text">500+ disponibles</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sección Final CTA -->
    <section class="final-cta-large">
        <div class="container text-center">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <h2 class="cta-title-large">Comienza Hoy Mismo</h2>
                    <p class="cta-description-large">
                        Únete a la revolución del estacionamiento inteligente. Ya seas conductor o gestor de
                        estacionamientos, tenemos la solución perfecta para optimizar tu experiencia de movilidad.
                    </p>
                    <div class="cta-actions-large">
                        <a th:href="@{/solicitar-acceso}" class="btn btn-primary btn-cta-large me-3">
                            <i class="fas fa-building me-2"></i>Registrar Estacionamiento
                        </a>
                        <a th:href="@{/descargar-app}" class="btn btn-outline-light btn-cta-large">
                            <i class="fas fa-download me-2"></i>Descargar App
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- Google Maps: initialization + fetching parkings from backend -->
    <script>
        // Map and markers will be initialized by Google Maps callback `initParkeaMap`
        let parkeaMap, userMarker, parkMarkers = [], infoWindow;

        function initParkeaMap() {
            // Wait for the #map element to exist before initializing.
            const defaultCenter = { lat: -8.109052, lng: -79.021530 };
            let attempts = 0;
            const maxAttempts = 50; // ~5 seconds with 100ms interval

            function tryInit() {
                const mapEl = document.getElementById('map');
                attempts++;
                if (!mapEl) {
                    if (attempts <= maxAttempts) {
                        // retry shortly
                        setTimeout(tryInit, 100);
                        return;
                    } else {
                        console.error('initParkeaMap: #map element not found after retries. Map initialization aborted.');
                        return;
                    }
                }

                parkeaMap = new google.maps.Map(mapEl, {
                    center: defaultCenter,
                    zoom: 13,
                    disableDefaultUI: false,
                    styles: []
                });
                infoWindow = new google.maps.InfoWindow();

                // Try to geolocate the user
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        parkeaMap.setCenter(userPos);
                        parkeaMap.setZoom(14);
                        userMarker = new google.maps.Marker({
                            position: userPos,
                            map: parkeaMap,
                            title: 'Tu ubicación',
                            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: '#00bcd4', fillOpacity: 0.95, strokeColor: '#fff', strokeWeight: 2 }
                        });
                        fetchAndRenderParkings(userPos);
                    }, () => fetchAndRenderParkings(null), { timeout: 10000 });
                } else {
                    fetchAndRenderParkings(null);
                }
            }

            tryInit();
        }

        async function fetchAndRenderParkings(userPos) {
            const base = (typeof PARKINGS_API_BASE !== 'undefined' ? PARKINGS_API_BASE : '');
            const endpoints = [
                base + '/api/parkings/',
                base + '/api/parkings/',
                base + '/api/parking/parkings',
                base + '/api/parking/parkings/',
                base + '/api/parking/',
                base + '/api/parking/',
                base + '/parkings',
                base + '/parkings/',
                base + '/api/parkings/list'
            ];
            let data = null;
            for (const ep of endpoints) {
                try {
                    console.debug('Trying parkings endpoint:', ep);
                    const res = await fetch(ep);
                    console.debug('Response status for', ep, res.status);
                    if (!res.ok) continue;
                    const txt = await res.text();
                    let parsed = null;
                    try { parsed = JSON.parse(txt); } catch (e) { parsed = txt; }
                    console.debug('Preview response for', ep, Array.isArray(parsed) ? parsed.slice(0,3) : parsed);
                    data = parsed;
                    if (Array.isArray(data)) break;
                    if (data && Array.isArray(data.results)) { data = data.results; break; }
                } catch (e) {
                    console.warn('Fetch error for', ep, e);
                    // try next endpoint
                }
            }
            if (!Array.isArray(data)) {
                console.warn('No se pudo cargar la lista de parkings. Revisar endpoint backend.', data);
                return;
            }

            // Clear existing markers
            parkMarkers.forEach(m => m.setMap(null));
            parkMarkers = [];

            let added = 0;
            data.forEach(p => {
                // Try multiple possible coordinate sources. many backends store a single `coordenadas` string like "lat,lng"
                let lat = parseFloat(p.latitude ?? p.lat ?? p.latitud ?? p.coords?.lat ?? p.location?.lat);
                let lng = parseFloat(p.longitude ?? p.lng ?? p.long ?? p.longitud ?? p.coords?.lng ?? p.location?.lng);
                if ((isNaN(lat) || isNaN(lng)) && p.coordenadas) {
                    // common formats: "lat,lng" or "lng,lat" or "POINT(lng lat)"
                    const s = String(p.coordenadas).trim();
                    // POINT(lon lat)
                    const pointMatch = s.match(/POINT\s*\(\s*([\-\d\.]+)\s+([\-\d\.]+)\s*\)/i);
                    if (pointMatch) {
                        const maybeLng = parseFloat(pointMatch[1]);
                        const maybeLat = parseFloat(pointMatch[2]);
                        if (!isNaN(maybeLat) && !isNaN(maybeLng)) {
                            lat = maybeLat; lng = maybeLng;
                        }
                    } else if (s.indexOf(',') !== -1) {
                        const parts = s.split(',').map(x => x.trim());
                        const a = parseFloat(parts[0]);
                        const b = parseFloat(parts[1]);
                        // Heuristic: if first value is between -90 and 90, treat as lat
                        if (!isNaN(a) && Math.abs(a) <= 90 && !isNaN(b) && Math.abs(b) <= 180) {
                            lat = a; lng = b;
                        } else if (!isNaN(b) && Math.abs(b) <= 90 && !isNaN(a) && Math.abs(a) <= 180) {
                            lat = b; lng = a;
                        }
                    } else {
                        // Try to extract two numbers anywhere in the string
                        const nums = s.match(/[\-\d\.]+/g);
                        if (nums && nums.length >= 2) {
                            const n1 = parseFloat(nums[0]);
                            const n2 = parseFloat(nums[1]);
                            if (Math.abs(n1) <= 90 && Math.abs(n2) <= 180) { lat = n1; lng = n2; }
                            else if (Math.abs(n2) <= 90 && Math.abs(n1) <= 180) { lat = n2; lng = n1; }
                        }
                    }
                }
                if (Number.isNaN(lat) || Number.isNaN(lng)) return;

                const marker = new google.maps.Marker({
                    position: { lat, lng },
                    map: parkeaMap,
                    title: p.name ?? p.nombre ?? 'Estacionamiento'
                });

                const available = p.available ?? p.available_spaces ?? p.plazas_disponibles ?? p.plazas ?? 'N/A';
                const price = p.price ?? p.rate ?? p.precio ?? 'N/A';
                const distanceKm = userPos ? (haversine(userPos.lat, userPos.lng, lat, lng) / 1000).toFixed(2) : null;

                const content = `
                    <div style="min-width:210px">
                        <h5 style="margin:0 0 6px 0">${escapeHtml(p.name ?? p.nombre ?? 'Estacionamiento')}</h5>
                        <div style="font-size:0.95rem; color:#333">
                            <div>Plazas disponibles: <strong>${escapeHtml(String(available))}</strong></div>
                            <div>Precio: <strong>${escapeHtml(String(price))}</strong></div>
                            ${distanceKm ? `<div>Distancia: <strong>${distanceKm} km</strong></div>` : ''}
                            ${p.address ? `<div style="margin-top:6px; font-size:0.85rem; color:#666">${escapeHtml(p.address)}</div>` : ''}
                        </div>
                    </div>
                `;

                marker.addListener('click', () => {
                    infoWindow.setContent(content);
                    infoWindow.open(parkeaMap, marker);
                });

                parkMarkers.push(marker);
                added++;
            });
            console.debug('Markers added:', added);
        }

        function haversine(lat1, lon1, lat2, lon2) {
            function toRad(v){ return v * Math.PI / 180; }
            const R = 6371000;
            const dLat = toRad(lat2-lat1);
            const dLon = toRad(lon2-lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) * Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'`':'&#x60'}[s]));
        }
    </script>

    <!-- Load Google Maps JS using key from application.properties (injected via Thymeleaf) -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var PARKEA_MAPS_API_KEY = /*[[${@environment.getProperty('google.maps.apiKey')}]]*/ 'REPLACE_ME';
        var PARKINGS_API_BASE = /*[[${@environment.getProperty('django.api.base-url')}]]*/ 'http://localhost:8000';
        /*]]>*/
    </script>

    <script>
        // Dynamic loader for Google Maps to avoid URL encoding issues with Thymeleaf
        (function loadGoogleMaps() {
            try {
                if (typeof google !== 'undefined' && google.maps) {
                    console.log('Google Maps already loaded');
                    return;
                }
            } catch (e) { /* ignore */ }

            if (!window.PARKEA_MAPS_API_KEY || window.PARKEA_MAPS_API_KEY === 'REPLACE_ME') {
                console.error('Google Maps API key is missing. Set google.maps.apiKey in application.properties.');
                return;
            }

            var script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(window.PARKEA_MAPS_API_KEY) + '&callback=initParkeaMap';
            script.async = true;
            script.defer = true;
            script.onerror = function () {
                console.error('Error cargando la librería de Google Maps. Revisa la API key y restricciones.');
            };
            document.head.appendChild(script);
        })();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Iniciando carrusel...');

            // --- LIMPIEZA AGRESIVA DE NODOS DE LOGS Y CONTROLES DUPLICADOS ---
            const heroRoot = document.querySelector('.hero-section');
            if (heroRoot) {
                // 1) Eliminar elementos <pre>/<code> o con clases comunes de logs
                heroRoot.querySelectorAll('pre, code, .console, .console-log, .server-log, .debug-output').forEach(el => el.remove());

                // 2) Eliminar nodos que contengan texto de inicialización del servidor (por si se inyectaron)
                heroRoot.querySelectorAll('*').forEach(el => {
                    const txt = (el.textContent || '').trim();
                    if (txt && /Initializing Servlet|DispatcherServlet|Completed initialization/i.test(txt)) {
                        // si el elemento contiene únicamente ese texto, eliminarlo
                        if (txt.length < 300 && (!el.querySelector('*') || el.childNodes.length === 1)) {
                            el.remove();
                        }
                    }
                });

                //  mantener sólo el primer .carousel-controls dentro del hero
                const ctrls = heroRoot.querySelectorAll('.carousel-controls');
                if (ctrls.length > 1) {
                    for (let i = 1; i < ctrls.length; i++) ctrls[i].remove();
                }
            }
            // --- FIN LIMPIEZA ---

            // Seleccionar elementos sólo dentro del control principal
            const slides = document.querySelectorAll('.carousel-slide');
            const prevBtn = document.querySelector('#hero-carousel-controls .carousel-prev');
            const nextBtn = document.querySelector('#hero-carousel-controls .carousel-next');

            if (slides.length === 0) {
                console.error('No se encontraron slides');
                return;
            }

            let currentSlide = 0;
            let slideInterval;
            const slideDuration = 5000; // 5 segundos

            // Función para inicializar el carrusel
            function initCarousel() {
                // Mostrar primer slide
                slides[0].classList.add('active');
                startCarousel();
            }

            // Función para cambiar de slide
            function goToSlide(n) {
                // Remover clase active del slide actual
                slides[currentSlide].classList.remove('active');

                // Actualizar índice
                currentSlide = (n + slides.length) % slides.length;

                // Añadir clase active al nuevo slide
                slides[currentSlide].classList.add('active');
            }

            // Función para siguiente slide
            function nextSlide() {
                goToSlide(currentSlide + 1);
            }

            // Función para slide anterior
            function prevSlide() {
                goToSlide(currentSlide - 1);
            }

            // Iniciar carrusel automático
            function startCarousel() {
                stopCarousel(); // Limpiar intervalo existente
                slideInterval = setInterval(nextSlide, slideDuration);
            }

            // Detener carrusel automático
            function stopCarousel() {
                if (slideInterval) {
                    clearInterval(slideInterval);
                }
            }

            // Event Listeners
            if (nextBtn) {
                nextBtn.addEventListener('click', function () {
                    stopCarousel();
                    nextSlide();
                    startCarousel();
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', function () {
                    stopCarousel();
                    prevSlide();
                    startCarousel();
                });
            }

            // Pausar carrusel al hacer hover
            const heroSection = document.querySelector('.hero-section');
            if (heroSection) {
                heroSection.addEventListener('mouseenter', stopCarousel);
                heroSection.addEventListener('mouseleave', startCarousel);
            }

            // Inicializar carrusel
            initCarousel();

            console.log('Carrusel iniciado correctamente');
        });
    </script>
</body>

</html>